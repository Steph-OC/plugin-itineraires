document.addEventListener("DOMContentLoaded",function(){function o(o){console.log("Fetching GPX file from URL:",o),fetch(o).then(o=>{if(console.log("Response from fetching GPX file:",o),!o.ok)throw new Error("Network response was not ok "+o.statusText);return o.text()}).then(o=>{console.log("GPX Data:",o);const e=new DOMParser,t=e.parseFromString(o,"application/xml"),n=u+"leaflet/images/pin-icon-start.png",r=u+"leaflet/images/pin-icon-end.png",l=u+"leaflet/images/marker-shadow.png",c=u+"leaflet/images/pin-icon-wpt.png";console.log("Start Icon URL:",n),console.log("End Icon URL:",r),console.log("Shadow URL:",l),console.log("Waypoint Icon URL:",c);const a=new L.GPX(t.documentElement.outerHTML,{async:!0,marker_options:{startIconUrl:n,endIconUrl:r,shadowUrl:l,wptIconUrls:{"":c}},polyline_options:{color:"red",weight:5,opacity:1,smoothFactor:1}}).on("loaded",function(o){g.fitBounds(o.target.getBounds())});m.push(a),a.addTo(g);const i=t.getElementsByTagName("wpt");Array.from(i).forEach((o,e)=>{const t=o.getAttribute("lat"),n=o.getAttribute("lon"),r=o.getElementsByTagName("name")[0].textContent,l=o.getElementsByTagName("desc")[0]?o.getElementsByTagName("desc")[0].textContent:"",c=L.divIcon({className:"waypoint-icon",html:`<div style="position: relative;"><i class="fa fa-map-marker" aria-hidden="true"></i><span style="position: absolute; top: 0; left: 0; transform: translate(-50%, -50%);">${e+1}</span></div>`,iconSize:[30,42],iconAnchor:[15,42]}),a=L.marker([t,n],{icon:c}).addTo(g).bindPopup(`<b>${r}</b><br>${l}`);p.push(a)})}).catch(o=>console.log("Error loading GPX file:",o))}function e(){m.forEach(o=>g.removeLayer(o)),m=[],p.forEach(o=>g.removeLayer(o)),p=[]}function t(t){e(),t.forEach(e=>o(e))}console.log("trail-map.js is loaded");const n=pluginDirUrl.buttonColor,r=pluginDirUrl.buttonTextColor,l=pluginDirUrl.buttonHoverColor,c=pluginDirUrl.buttonFocusColor,a=document.getElementById("copy-shortcode"),i=document.getElementById("trail-map-shortcode");a&&i?(console.log("Copy button and shortcode element found"),a.addEventListener("click",function(){const o=document.createRange();o.selectNode(i),window.getSelection().removeAllRanges(),window.getSelection().addRange(o);try{const o=document.execCommand("copy");o?alert("Shortcode copié dans le presse-papiers !"):console.error("Erreur lors de la copie du shortcode.")}catch(o){console.error("Erreur lors de la copie du shortcode : ",o)}window.getSelection().removeAllRanges()})):console.log("Copy button or shortcode element not found");const s=document.querySelector(".plugin-section-title");if(s){const o=pluginDirUrl.sectionTitleColor;s.style.color=o}const d=document.getElementById("map");if(!d)return void console.log("Map container not found");const u=pluginDirUrl.url,g=L.map("map",{center:[mapSettings.latitude,mapSettings.longitude],zoom:mapSettings.zoom,scrollWheelZoom:!1,doubleClickZoom:!0,touchZoom:!0});L.tileLayer("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; OpenStreetMap France | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(g),void 0!==L.control.fullscreen?g.addControl(new L.control.fullscreen):console.error("Fullscreen control is not available.");let m=[],p=[];document.querySelectorAll(".show-trail").forEach(function(t){t.style.backgroundColor=n,t.style.color=r,t.addEventListener("mouseover",function(){t.style.backgroundColor=l}),t.addEventListener("mouseout",function(){t.style.backgroundColor=n}),t.addEventListener("focus",function(){t.style.backgroundColor=c}),t.addEventListener("blur",function(){t.style.backgroundColor=n}),t.addEventListener("click",function(){e(),o(t.getAttribute("data-url"));const n=t.getAttribute("data-description"),r=t.getAttribute("data-distance"),l=t.getAttribute("data-difficulty"),c=t.getAttribute("data-duration"),a=t.getAttribute("data-precautions"),i=document.getElementById("trail-description");i&&(i.innerHTML=`\n                    <h3>Informations du parcours</h3>\n                    <p><strong>Distance :</strong> ${r} km</p>\n                    <p><strong>Difficulté :</strong> ${l}</p>\n                    <p><strong>Durée :</strong> ${c}</p>\n                    <h3>Description</h3>\n                    <p>${n}</p>\n                    <p><strong>Précautions :</strong> ${a}</p>\n                `,i.style.display="block")})});const f=document.getElementById("show-all");f&&(f.style.backgroundColor=n,f.style.color=r,f.addEventListener("mouseover",function(){f.style.backgroundColor=l}),f.addEventListener("mouseout",function(){f.style.backgroundColor=n}),f.addEventListener("focus",function(){f.style.backgroundColor=c}),f.addEventListener("blur",function(){f.style.backgroundColor=n}),f.addEventListener("click",function(){const o=Array.from(document.querySelectorAll(".show-trail")).map(o=>o.getAttribute("data-url"));t(o);const e=document.getElementById("trail-description");e&&(e.style.display="none")}));const y=document.getElementById("trail-description");let h;y&&(y.style.display="none");let b=!1,E=null;const v=L.control({position:"topright"});v.onAdd=function(o){const e=L.DomUtil.create("div","leaflet-bar leaflet-control locate-icon");return e.innerHTML='<a href="#" title="Locate me"><i class="fa fa-map-marker" aria-hidden="true"></i></a>',e.onclick=function(){return b?(E&&(navigator.geolocation.clearWatch(E),E=null),b=!1,e.querySelector("i").style.color="red",h&&(o.removeLayer(h),h=null)):(E=navigator.geolocation.watchPosition(function(e){const t=L.divIcon({className:"user-location-icon",html:'<i class="fas fa-street-view"></i>',iconSize:[30,30],iconAnchor:[15,15]});h?h.setLatLng([e.coords.latitude,e.coords.longitude]):h=L.marker([e.coords.latitude,e.coords.longitude],{icon:t}).addTo(o),o.setView([e.coords.latitude,e.coords.longitude],16)},function(o){alert("Erreur de localisation: "+o.message)},{enableHighAccuracy:!0,maximumAge:0,timeout:6e4}),b=!0,e.querySelector("i").style.color="green"),!1},e},v.addTo(g),g.on("touchstart",function(o){1===o.originalEvent.touches.length?g.dragging.disable():g.dragging.enable()}),g.on("touchend",function(){g.dragging.enable()}),g.on("touchmove",function(o){1===o.originalEvent.touches.length&&o.preventDefault()})});