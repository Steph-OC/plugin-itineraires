document.addEventListener("DOMContentLoaded",function(){function e(e){console.log("Fetching GPX file from URL:",e),fetch(e).then(e=>{if(console.log("Response from fetching GPX file:",e),!e.ok)throw new Error("Network response was not ok "+e.statusText);return e.text()}).then(e=>{console.log("GPX Data:",e);const o=new DOMParser,t=o.parseFromString(e,"application/xml"),n=u+"leaflet/images/pin-icon-start.png",r=u+"leaflet/images/pin-icon-end.png",l=u+"leaflet/images/marker-shadow.png",a=u+"leaflet/images/pin-icon-wpt.png";console.log("Start Icon URL:",n),console.log("End Icon URL:",r),console.log("Shadow URL:",l),console.log("Waypoint Icon URL:",a);const i=new L.GPX(t.documentElement.outerHTML,{async:!0,marker_options:{startIconUrl:n,endIconUrl:r,shadowUrl:l,wptIconUrls:{"":a}},polyline_options:{color:"red",weight:5,opacity:1,smoothFactor:1}}).on("loaded",function(e){g.fitBounds(e.target.getBounds())});p.push(i),i.addTo(g);const c=t.getElementsByTagName("wpt");Array.from(c).forEach((e,o)=>{const t=e.getAttribute("lat"),n=e.getAttribute("lon"),r=e.getElementsByTagName("name")[0].textContent,l=e.getElementsByTagName("desc")[0]?e.getElementsByTagName("desc")[0].textContent:"",a=L.divIcon({className:"waypoint-icon",html:`<div style="position: relative;"><i class="fa fa-map-marker" aria-hidden="true"></i><span style="position: absolute; top: 0; left: 0; transform: translate(-50%, -50%);">${o+1}</span></div>`,iconSize:[30,42],iconAnchor:[15,42]}),i=L.marker([t,n],{icon:a}).addTo(g).bindPopup(`<b>${r}</b><br>${l}`);m.push(i)})}).catch(e=>console.log("Error loading GPX file:",e))}function o(){p.forEach(e=>g.removeLayer(e)),p=[],m.forEach(e=>g.removeLayer(e)),m=[]}function t(t){o(),t.forEach(o=>e(o))}console.log("trail-map.js is loaded");const n=pluginDirUrl.buttonColor,r=pluginDirUrl.buttonTextColor,l=pluginDirUrl.buttonHoverColor,a=pluginDirUrl.buttonFocusColor,i=document.getElementById("copy-shortcode"),c=document.getElementById("trail-map-shortcode");i&&c?(console.log("Copy button and shortcode element found"),i.addEventListener("click",function(){const e=document.createRange();e.selectNode(c),window.getSelection().removeAllRanges(),window.getSelection().addRange(e);try{const e=document.execCommand("copy");e?alert("Shortcode copié dans le presse-papiers !"):console.error("Erreur lors de la copie du shortcode.")}catch(e){console.error("Erreur lors de la copie du shortcode : ",e)}window.getSelection().removeAllRanges()})):console.log("Copy button or shortcode element not found");const s=document.querySelector(".plugin-section-title");if(s){const e=pluginDirUrl.sectionTitleColor;s.style.color=e}const d=document.getElementById("map");if(!d)return void console.log("Map container not found");const u=pluginDirUrl.url,g=L.map("map").setView([mapSettings.latitude,mapSettings.longitude],mapSettings.zoom);L.tileLayer("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; OpenStreetMap France | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(g),void 0!==L.control.fullscreen?g.addControl(new L.control.fullscreen):console.error("Fullscreen control is not available.");let p=[],m=[];document.querySelectorAll(".show-trail").forEach(function(t){t.style.backgroundColor=n,t.style.color=r,t.addEventListener("mouseover",function(){t.style.backgroundColor=l}),t.addEventListener("mouseout",function(){t.style.backgroundColor=n}),t.addEventListener("focus",function(){t.style.backgroundColor=a}),t.addEventListener("blur",function(){t.style.backgroundColor=n}),t.addEventListener("click",function(){o(),e(t.getAttribute("data-url"));const n=t.getAttribute("data-description"),r=t.getAttribute("data-distance"),l=t.getAttribute("data-difficulty"),a=t.getAttribute("data-duration"),i=t.getAttribute("data-precautions"),c=document.getElementById("trail-description");if(c){let e="<h3>Informations du parcours</h3>",o=!1;r&&(e+=`<p><strong>Distance :</strong> ${r} km</p>`,o=!0),l&&(e+=`<p><strong>Difficulté :</strong> ${l}</p>`,o=!0),a&&(e+=`<p><strong>Durée :</strong> ${a}</p>`,o=!0),n&&(e+=`<h3>Description</h3><p>${n}</p>`,o=!0),i&&(e+=`<p><strong>Précautions :</strong> ${i}</p>`,o=!0),o?(c.innerHTML=e,c.style.display="block"):c.style.display="none"}})});const f=document.getElementById("show-all");f&&(f.style.backgroundColor=n,f.style.color=r,f.addEventListener("mouseover",function(){f.style.backgroundColor=l}),f.addEventListener("mouseout",function(){f.style.backgroundColor=n}),f.addEventListener("focus",function(){f.style.backgroundColor=a}),f.addEventListener("blur",function(){f.style.backgroundColor=n}),f.addEventListener("click",function(){const e=Array.from(document.querySelectorAll(".show-trail")).map(e=>e.getAttribute("data-url"));t(e);const o=document.getElementById("trail-description");o&&(o.style.display="none")}));const y=document.getElementById("trail-description");let h;y&&(y.style.display="none");let b=!1,E=null;const v=L.control({position:"topright"});v.onAdd=function(e){const o=L.DomUtil.create("div","leaflet-bar leaflet-control locate-icon");return o.innerHTML='<a href="#" title="Locate me"><i class="fa fa-map-marker" aria-hidden="true"></i></a>',o.onclick=function(){return b?(E&&(navigator.geolocation.clearWatch(E),E=null),b=!1,o.querySelector("i").style.color="red",h&&(e.removeLayer(h),h=null)):(E=navigator.geolocation.watchPosition(function(o){const t=L.divIcon({className:"user-location-icon",html:'<i class="fas fa-street-view"></i>',iconSize:[30,30],iconAnchor:[15,15]});h?h.setLatLng([o.coords.latitude,o.coords.longitude]):h=L.marker([o.coords.latitude,o.coords.longitude],{icon:t}).addTo(e),e.setView([o.coords.latitude,o.coords.longitude],16)},function(e){alert("Erreur de localisation: "+e.message)},{enableHighAccuracy:!0,maximumAge:0,timeout:6e4}),b=!0,o.querySelector("i").style.color="green"),!1},o},v.addTo(g)});